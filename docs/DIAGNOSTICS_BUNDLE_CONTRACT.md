# E2E Diagnostics Bundle Contract

This document defines the expected contents and interpretation of the **E2E diagnostics bundle** generated by the ecosystem E2E runner in `scripts/e2e-runner.ps1`.

## When A Bundle Is Created

A diagnostics bundle is created when:

- A gate **fails**, or
- CI is configured to upload diagnostics on success (debug mode), or
- A local run requests diagnostics explicitly (implementation-dependent).

The bundle is designed to be shareable for AI-assisted triage: sensitive values are redacted before writing files.

## Bundle Layout (Zip Contents)

The zip contains a folder (unique per run) with some/all of these files:

- `run-manifest.json`
  - Machine-readable summary of the run, including gate outcomes, error codes, host fingerprinting, and source SHAs.
  - This is the primary “entry point” for triage.
- `container-logs.txt`
  - `docker logs --tail 500` output for the Lidarr container used in the run.
- `inspect.json`
  - `docker inspect` output for the container (when available).
- `system-status.json`
  - `GET /api/v1/system/status` (Lidarr status snapshot).
- `indexer-schemas.json`
  - `GET /api/v1/indexer/schema` (verifies plugin registration and settings fields).
- `downloadclient-schemas.json`
  - `GET /api/v1/downloadclient/schema`.
- `importlist-schemas.json`
  - `GET /api/v1/importlist/schema`.
- `configured-indexers.json`
  - `GET /api/v1/indexer` with secrets redacted.
- `configured-downloadclients.json`
  - `GET /api/v1/downloadclient` with secrets redacted.
- `queue-state.json`
  - `GET /api/v1/queue` (helps diagnose grab/download behavior).

Notes:

- Some files may be missing if Docker is unavailable, Lidarr is unreachable, or a run was executed with diagnostics disabled.
- CI may upload `run-manifest.json` separately as an artifact in addition to the bundle.

## Redaction Rules

Redaction is applied before files are written. You should expect placeholders like:

- `[REDACTED]` for secrets (tokens, passwords, API keys, authorization codes).
- `[PRIVATE-IP]` / `[PRIVATE-IPv6]` for RFC1918 / local IPv6 addresses.
- `[INTERNAL-HOST]` / `[LOCALHOST]` for internal hostnames.

The runner also executes a redaction self-test (recorded in `run-manifest.json`) to reduce the risk of accidental leakage.

## How To Triage A Failure (Fast Path)

1. Open `run-manifest.json`.
2. Find the first result with `outcome: "failed"`.
3. Use:
   - `errorCode` (machine triage)
   - `outcomeReason` (human next action)
   - `details` (gate-specific context: ids, counts, selected release title)
4. If `hostBugSuspected.detected == true`, check:
   - `hostBugSuspected.classification`
   - `hostBugSuspected.severity`
   - `hostBugSuspected.matchedLine`
5. If the failure is `Grab`/`PostRestartGrab`, open:
   - `queue-state.json`
   - `container-logs.txt` (look for plugin exceptions around the grab time)

## Host Bug Classifier Meanings

When present, `hostBugSuspected` is a classifier for load-time/runtime errors:

- `ALC` (`host_bug`): AssemblyLoadContext lifecycle/unload issues (often upstream Lidarr).
- `ABI_MISMATCH` (`plugin_rebuild`): plugin built against incompatible host assemblies (rebuild against the pinned Lidarr tag).
- `DEPENDENCY_DRIFT` (`version_conflict`): conflicting assembly versions between host/plugin.
- `LOAD_FAILURE` (`investigate`): generic load failure; inspect logs + packaging policy.
- `TYPE_INIT_FAILURE` (`investigate`): type initializer errors; usually configuration/environment-specific.

## What To Share For AI-Assisted Debugging

If you want an AI to triage a failure quickly, share:

- `run-manifest.json`
- the entire diagnostics bundle zip (preferred)

And include:

- which gate you ran (`bootstrap`, `all`, etc.)
- the Lidarr image tag/digest
- whether you enabled canary/cold-start/post-restart-grab/metadata/Brainarr LLM gates

Do **not** share raw secrets, unredacted config folders, or token files.
