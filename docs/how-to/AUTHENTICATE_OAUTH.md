# How-to: Authenticate with OAuth

Many streaming services require OAuth flows. The shared library provides helpers so you do not have to re-implement token lifecycles.

## Components

- `OAuthStreamingAuthenticationService` – handles code/token exchange, refresh token persistence, and token storage.
- `OAuthDelegatingHandler` – attaches bearer tokens to outgoing HTTP requests and performs single-flight refreshes on `401`.
- `IStreamingTokenProvider` – abstraction for retrieving and storing tokens (backed by your plugin settings).

## Implementation steps

1. **Create settings** that hold client id/secret/redirect URI.
2. **Implement `IStreamingTokenProvider`** to persist tokens via the plugin settings provider.
3. **Instantiate `OAuthStreamingAuthenticationService`** with service metadata (auth URLs, scopes).
4. **Attach `OAuthDelegatingHandler`** to your `HttpClient`.

```csharp

var tokenProvider = new MyTokenProvider(settingsProvider);
var authService = new OAuthStreamingAuthenticationService(options, tokenProvider, loggerFactory.CreateLogger<OAuthStreamingAuthenticationService>());
var httpClient = HttpClientFactory.Create(new OAuthDelegatingHandler(tokenProvider, authService, loggerFactory.CreateLogger<OAuthDelegatingHandler>()));

```

## Handling user consent

- Expose a UI flow that launches the authorization URL generated by `authService.BuildAuthorizationUrl(state)`.
- When the callback arrives, call `authService.ExchangeCodeAsync(code)` to persist tokens.

## Refresh lifecycle

- `OAuthDelegatingHandler` ensures refresh is single-flight and shared across concurrent requests.
- Configure retry budgets so a failing refresh does not hammer the auth endpoint.

## Persistence and concurrency

- The base authentication service persists token envelopes to disk using a durable token store.
- Writes are atomic and crash-safe; reads tolerate stale temp files.
- On Windows, the store uses a named mutex and unique temp files with short retries to avoid transient sharing violations.
- Secrets are masked in logs by default; keep error messages free of tokens.

## Testing

- Stub `IStreamingTokenProvider` with in-memory implementations.
- Use integration tests with mocked HTTP endpoints to ensure refresh occurs on `401`.

## Further reading

- [Developer guide → Authentication](../dev-guide/DEVELOPER_GUIDE.md#authentication)
- [Manage sessions/tokens with StreamingTokenManager](TOKEN_MANAGER.md)
- [Release policy](../dev-guide/RELEASE_POLICY.md)
