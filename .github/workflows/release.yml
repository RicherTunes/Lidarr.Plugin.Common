name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write  # Required for keyless signing with Cosign

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_pack_publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - name: Configure private TagLib feed (release only)
        if: startsWith(github.ref, 'refs/tags/v') && env.ADO_TAGLIB_NUGET_URL != ''
        env:
          ADO_TAGLIB_NUGET_URL: ${{ secrets.ADO_TAGLIB_NUGET_URL }}
        run: |
          dotnet nuget add source --name lidarr-taglib "$ADO_TAGLIB_NUGET_URL"

      - name: Restore & Build (no analyzers)
        run: |
          dotnet restore -p:UseLidarrTagLib=true
          dotnet build -c Release -warnaserror -p:RunAnalyzersDuringBuild=false -m:1 -p:UseLidarrTagLib=true

      - name: Public API drift
        run: dotnet format src/Abstractions/Lidarr.Plugin.Abstractions.csproj analyzers --verify-no-changes --diagnostics RS0016,RS0017 -p:TargetFramework=net8.0

      - name: Test (PR/branch)
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        run: dotnet test -c Release --no-build --collect:"XPlat Code Coverage"

      - name: Test (release tag; skip known timing flake)
        if: startsWith(github.ref, 'refs/tags/v')
        run: >
          dotnet test -c Release --no-build --collect:"XPlat Code Coverage"
          --filter FullyQualifiedName!~RetrySemanticsTests.ExecuteWithResilienceAsync_PrefersRetryAfterDate_AndClampsToBudget

      - name: Verify tag matches package versions
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF#refs/tags/}"
          VER="${TAG#v}"
          echo "Verifying tag '$TAG' matches <Version> '$VER' in csprojs..."
          grep -q "<Version>${VER}</Version>" src/Lidarr.Plugin.Common.csproj
          grep -q "<Version>${VER}</Version>" src/Abstractions/Lidarr.Plugin.Abstractions.csproj
          echo "OK: Tag matches package versions."

      - name: Pack
        run: |
          dotnet pack src/Abstractions/Lidarr.Plugin.Abstractions.csproj -c Release -o dist /p:ContinuousIntegrationBuild=true -p:UseLidarrTagLib=true
          dotnet pack src/Lidarr.Plugin.Common.csproj -c Release -o dist /p:ContinuousIntegrationBuild=true -p:UseLidarrTagLib=true

      # ═══════════════════════════════════════════════════════════════════════════
      # Canonical Abstractions DLL for plugin packaging (no NuGet key required)
      # Plugins download this exact DLL to ensure byte-identical Abstractions
      # ═══════════════════════════════════════════════════════════════════════════
      - name: Prepare canonical Abstractions DLL
        id: abstractions
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF#refs/tags/}"
          VER="${TAG#v}"
          SHA=$(git rev-parse --short=7 HEAD)

          # Source paths (Release build output)
          SRC_DLL="src/Abstractions/bin/Release/net8.0/Lidarr.Plugin.Abstractions.dll"
          SRC_PDB="src/Abstractions/bin/Release/net8.0/Lidarr.Plugin.Abstractions.pdb"

          # Versioned names for release assets
          # Format: Lidarr.Plugin.Abstractions-{version}-{sha}.dll
          DLL_NAME="Lidarr.Plugin.Abstractions-${VER}-${SHA}.dll"
          PDB_NAME="Lidarr.Plugin.Abstractions-${VER}-${SHA}.pdb"

          # Also provide stable names (latest for this version, no SHA suffix)
          STABLE_DLL_NAME="Lidarr.Plugin.Abstractions.dll"
          STABLE_PDB_NAME="Lidarr.Plugin.Abstractions.pdb"

          cp "$SRC_DLL" "dist/$DLL_NAME"
          cp "$SRC_PDB" "dist/$PDB_NAME"
          cp "$SRC_DLL" "dist/$STABLE_DLL_NAME"
          cp "$SRC_PDB" "dist/$STABLE_PDB_NAME"

          echo "dll_name=$DLL_NAME" >> $GITHUB_OUTPUT
          echo "pdb_name=$PDB_NAME" >> $GITHUB_OUTPUT
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

          echo "✓ Prepared canonical Abstractions DLL: $DLL_NAME"

      - name: API compatibility (Abstractions vs previous)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet tool update --global microsoft.dotnet.apicompat.tool --version 9.0.305
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          PREV_TAG=$(gh release view --json tagName --jq .tagName 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "No previous release detected; skipping API compatibility."
            exit 0
          fi
          mkdir -p prev
          if ! gh release download "$PREV_TAG" -p "Lidarr.Plugin.Abstractions.*.nupkg" -D prev; then
            echo "Previous release found but no Abstractions package; skipping API compatibility."
            exit 0
          fi
          CURRENT_PACKAGE=$(ls dist/Lidarr.Plugin.Abstractions.*.nupkg | head -n 1)
          PREV_PACKAGE=$(ls prev/Lidarr.Plugin.Abstractions.*.nupkg | head -n 1)
          if [ -z "$PREV_PACKAGE" ] || [ -z "$CURRENT_PACKAGE" ]; then
            echo "Missing package for API compatibility; skipping."
            exit 0
          fi
          apicompat package --package "$CURRENT_PACKAGE" --baseline-package "$PREV_PACKAGE"

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: dist/sbom.spdx.json

      - name: Generate SHA256 checksums
        run: |
          cd dist
          # Checksums for NuGet packages
          for f in *.nupkg; do
            sha256sum "$f" > "$f.sha256"
          done
          # Checksums for canonical Abstractions DLL (for plugin CI verification)
          for f in Lidarr.Plugin.Abstractions*.dll; do
            sha256sum "$f" > "$f.sha256"
          done

      - name: Install Cosign
        if: startsWith(github.ref, 'refs/tags/v')
        uses: sigstore/cosign-installer@v3

      - name: Sign packages with Cosign (keyless)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cd dist
          for f in *.nupkg; do
            cosign sign-blob --yes --output-signature "$f.sig" "$f"
          done

      - name: Publish to NuGet.org (if API key present)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${NUGET_API_KEY:-}" ]; then
            echo "NUGET_API_KEY not set; skipping publish to NuGet.org."
            exit 0
          fi
          dotnet nuget push "dist/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key "$NUGET_API_KEY" --skip-duplicate

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: Lidarr.Plugin.Common ${{ github.ref_name }}
          body: |
            ## Lidarr.Plugin.Common ${{ github.ref_name }}

            ### Installation
            Install via NuGet:
            ```
            dotnet add package Lidarr.Plugin.Common --version ${{ github.ref_name }}
            dotnet add package Lidarr.Plugin.Abstractions --version ${{ github.ref_name }}
            ```

            ### Plugin Packaging (Canonical Abstractions DLL)
            For byte-identical plugin packaging without NuGet:
            ```bash
            # Download canonical Abstractions DLL
            gh release download ${{ github.ref_name }} -p "Lidarr.Plugin.Abstractions.dll" -D output/
            gh release download ${{ github.ref_name }} -p "Lidarr.Plugin.Abstractions.dll.sha256" -D output/
            # Verify SHA256
            sha256sum -c output/Lidarr.Plugin.Abstractions.dll.sha256
            ```

            ### Security
            - SHA256 checksums provided for integrity verification
            - Cosign signatures for artifact authenticity
            - SBOM (Software Bill of Materials) included

            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for detailed changes.
          files: |
            dist/*.nupkg
            dist/*.dll
            dist/*.pdb
            dist/*.sha256
            dist/*.sig
            dist/sbom.spdx.json
          draft: false
          prerelease: false
