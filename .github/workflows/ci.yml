name: CI

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'

concurrency:
  group: ci-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build_and_test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDKs (8 & 6)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            6.0.x

      - name: Show dotnet info
        run: dotnet --info

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/global.json', '**/NuGet.config') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Dotnet format (verify)
        run: dotnet format --verify-no-changes

      - name: Build (Release, warnings as errors)
        run: dotnet build -c Release -warnaserror

      - name: Test (all TFMs) + coverage
        run: >
          dotnet test -c Release --no-build
          --collect:"XPlat Code Coverage"
          --logger "trx;LogFileName=test_results.trx"

      - name: Upload test & coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-and-coverage-${{ matrix.os }}
          path: |
            **/TestResults/*.trx
            **/TestResults/*/coverage.cobertura.xml

      - name: Annotate PR with test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/TestResults/*.trx"

      - name: Coverage summary in PR
        if: always()
        uses: irongut/CodeCoverageSummary@v1.3.1
        with:
          filename: "**/TestResults/*/coverage.cobertura.xml"
          fail_below_min: true
          format: markdown
          output: both
          thresholds: '60 80'

  pack_dry_run:
    name: Pack (dry run)
    runs-on: ubuntu-latest
    needs: build_and_test

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            6.0.x
      - name: Restore
        run: dotnet restore
      - name: Pack nupkg
        run: >
          dotnet pack src/Lidarr.Plugin.Common.csproj
          -c Release -o dist /p:ContinuousIntegrationBuild=true
      - name: Upload nupkg
        uses: actions/upload-artifact@v4
        with:
          name: nupkg
          path: dist/*.nupkg
