# Reusable workflow for plugin lint enforcement
# Call from plugin repos: uses: RicherTunes/Lidarr.Plugin.Common/.github/workflows/lint-enforcement.yml@main

name: Lint Enforcement

on:
  workflow_call:
    inputs:
      skip_test_lint:
        description: 'Skip raw dotnet test lint check'
        required: false
        default: false
        type: boolean
      skip_docs_lint:
        description: 'Skip docs drift sentinel check'
        required: false
        default: false
        type: boolean

jobs:
  lint:
    name: Lint Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Init Common submodule only
        shell: bash
        run: |
          git submodule sync -- ext/Lidarr.Plugin.Common 2>/dev/null || git submodule sync -- ext/lidarr.plugin.common
          git submodule update --init --depth=1 -- ext/Lidarr.Plugin.Common 2>/dev/null || git submodule update --init --depth=1 -- ext/lidarr.plugin.common

      - name: Install PowerShell
        shell: bash
        run: |
          if ! command -v pwsh &> /dev/null; then
            . /etc/os-release
            CODENAME=${VERSION_CODENAME:-"jammy"}
            curl -fsSL "https://packages.microsoft.com/config/ubuntu/$CODENAME/packages-microsoft-prod.deb" -o packages-microsoft-prod.deb \
              || curl -fsSL "https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb" -o packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y powershell
          fi

      - name: Raw dotnet test lint
        if: ${{ !inputs.skip_test_lint }}
        shell: pwsh
        run: |
          $commonPath = if (Test-Path "ext/Lidarr.Plugin.Common") { "ext/Lidarr.Plugin.Common" } else { "ext/lidarr.plugin.common" }
          $script = Join-Path $commonPath "scripts/lint-test-usage.ps1"
          if (Test-Path $script) {
            & $script -CI
          } else {
            Write-Host "::warning::Lint script not found at $script"
          }

      - name: Docs drift sentinel
        if: ${{ !inputs.skip_docs_lint }}
        shell: pwsh
        run: |
          $commonPath = if (Test-Path "ext/Lidarr.Plugin.Common") { "ext/Lidarr.Plugin.Common" } else { "ext/lidarr.plugin.common" }
          $script = Join-Path $commonPath "scripts/lint-docs-links.ps1"
          if (Test-Path $script) {
            & $script -CommonPath $commonPath -CI
          } else {
            Write-Host "::warning::Docs lint script not found at $script"
          }
