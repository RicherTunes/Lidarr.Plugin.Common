# Nightly E2E with live APIs - comprehensive, requires credentials
# Runs: all gates including golden-persist and authfail-redaction
# Schedule: 02:00 UTC (before plugin nightlies at 03:00/04:00 UTC)

name: E2E Nightly Live

on:
  schedule:
    # Run at 02:00 UTC daily (before plugin-specific nightlies)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_plugins:
        description: "Comma-separated plugins (default: qobuzarr,tidalarr)"
        type: string
        required: false
        default: qobuzarr,tidalarr
      run_canary:
        description: "Also run against pr-plugins tag (allowed to fail)"
        type: boolean
        required: false
        default: true
      grab_timeout_seconds:
        description: "Grab gate timeout (nightly can be longer)"
        type: string
        required: false
        default: "600"
  # Allow plugins to call this workflow
  workflow_call:
    inputs:
      test_plugins:
        description: "Comma-separated plugins (default: qobuzarr,tidalarr)"
        type: string
        required: false
        default: qobuzarr,tidalarr
      run_canary:
        description: "Also run against pr-plugins tag (allowed to fail)"
        type: boolean
        required: false
        default: true
      grab_timeout_seconds:
        description: "Grab gate timeout (nightly can be longer)"
        type: string
        required: false
        default: "600"
    secrets:
      CROSS_REPO_PAT:
        required: true
      QOBUZARR_EMAIL:
        required: false
      QOBUZARR_PASSWORD:
        required: false
      QOBUZARR_USER_ID:
        required: false
      QOBUZARR_AUTH_TOKEN:
        required: false
      QOBUZARR_APP_ID:
        required: false
      QOBUZARR_APP_SECRET:
        required: false
      QOBUZARR_COUNTRY_CODE:
        required: false
      QOBUZ_EMAIL:
        required: false
      QOBUZ_PASSWORD:
        required: false
      QOBUZ_USER_ID:
        required: false
      QOBUZ_AUTH_TOKEN:
        required: false
      QOBUZ_APP_ID:
        required: false
      QOBUZ_APP_SECRET:
        required: false
      QOBUZ_COUNTRY_CODE:
        required: false
      TIDALARR_REDIRECT_URL:
        required: false
      TIDALARR_MARKET:
        required: false
      TIDALARR_CLIENT_ID:
        required: false
      TIDALARR_CLIENT_SECRET:
        required: false
      TIDAL_REDIRECT_URL:
        required: false
      TIDAL_MARKET:
        required: false
      TIDAL_CLIENT_ID:
        required: false
      TIDAL_CLIENT_SECRET:
        required: false

# Prevent overlapping nightly runs
concurrency:
  group: e2e-nightly-live-${{ github.repository }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

env:
  DOTNET_NOLOGO: "true"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"

jobs:
  live-e2e:
    name: Live E2E (Full Suite)
    timeout-minutes: 45
    uses: ./.github/workflows/multi-plugin-smoke-test.yml
    with:
      test_plugins: ${{ inputs.test_plugins || 'qobuzarr,tidalarr' }}
      lidarr_tag: pr-plugins-3.1.1.4884
      # Enable all live gates
      run_medium_gate: true
      run_downloadclient_gate: true
      run_search_gate: true
      run_grab_gate: true
      require_downloaded_files: true
      grab_timeout_seconds: ${{ inputs.grab_timeout_seconds || '600' }}
      # Persistence + security gates
      run_golden_persist_gate: true
      run_authfail_redaction_gate: true
      # Drift sentinel: validate stub-vs-live field expectations (warning mode for now)
      run_drift_sentinel_gate: true
      drift_sentinel_fail_on_drift: false
      drift_sentinel_include_success_mode: true
      # Canary for early warning
      run_canary: ${{ inputs.run_canary || true }}
      e2e_mode: live
    secrets:
      CROSS_REPO_PAT: ${{ secrets.CROSS_REPO_PAT }}
      # Qobuz credentials (use prefixed names)
      QOBUZARR_EMAIL: ${{ secrets.QOBUZARR_EMAIL }}
      QOBUZARR_PASSWORD: ${{ secrets.QOBUZARR_PASSWORD }}
      QOBUZARR_USER_ID: ${{ secrets.QOBUZARR_USER_ID }}
      QOBUZARR_AUTH_TOKEN: ${{ secrets.QOBUZARR_AUTH_TOKEN }}
      QOBUZARR_APP_ID: ${{ secrets.QOBUZARR_APP_ID }}
      QOBUZARR_APP_SECRET: ${{ secrets.QOBUZARR_APP_SECRET }}
      QOBUZARR_COUNTRY_CODE: ${{ secrets.QOBUZARR_COUNTRY_CODE }}
      # Fallback names
      QOBUZ_EMAIL: ${{ secrets.QOBUZ_EMAIL }}
      QOBUZ_PASSWORD: ${{ secrets.QOBUZ_PASSWORD }}
      QOBUZ_USER_ID: ${{ secrets.QOBUZ_USER_ID }}
      QOBUZ_AUTH_TOKEN: ${{ secrets.QOBUZ_AUTH_TOKEN }}
      QOBUZ_APP_ID: ${{ secrets.QOBUZ_APP_ID }}
      QOBUZ_APP_SECRET: ${{ secrets.QOBUZ_APP_SECRET }}
      QOBUZ_COUNTRY_CODE: ${{ secrets.QOBUZ_COUNTRY_CODE }}
      # Tidal credentials
      TIDALARR_REDIRECT_URL: ${{ secrets.TIDALARR_REDIRECT_URL }}
      TIDALARR_MARKET: ${{ secrets.TIDALARR_MARKET }}
      TIDALARR_CLIENT_ID: ${{ secrets.TIDALARR_CLIENT_ID }}
      TIDALARR_CLIENT_SECRET: ${{ secrets.TIDALARR_CLIENT_SECRET }}
      TIDAL_REDIRECT_URL: ${{ secrets.TIDAL_REDIRECT_URL }}
      TIDAL_MARKET: ${{ secrets.TIDAL_MARKET }}
      TIDAL_CLIENT_ID: ${{ secrets.TIDAL_CLIENT_ID }}
      TIDAL_CLIENT_SECRET: ${{ secrets.TIDAL_CLIENT_SECRET }}

  # Create/update drift tracking issue when drift is detected
  drift-issue:
    name: Update Drift Tracking Issue
    needs: live-e2e
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download drift artifact
        uses: actions/download-artifact@v4
        with:
          pattern: multi-plugin-smoke-*-artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Check for drift and update issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find drift-sentinel.json in downloaded artifacts
            let driftData = null;
            const artifactDirs = ['.docker-multi-smoke-test'];

            for (const dir of artifactDirs) {
              const searchPaths = [
                `${dir}/artifacts/e2e/drift-sentinel.json`,
                `artifacts/e2e/drift-sentinel.json`,
                'drift-sentinel.json'
              ];

              for (const searchPath of searchPaths) {
                try {
                  // Search recursively
                  const files = require('child_process')
                    .execSync(`find . -name "drift-sentinel.json" 2>/dev/null || true`)
                    .toString()
                    .trim()
                    .split('\n')
                    .filter(f => f);

                  if (files.length > 0) {
                    const content = fs.readFileSync(files[0], 'utf8');
                    driftData = JSON.parse(content);
                    console.log(`Found drift data at: ${files[0]}`);
                    break;
                  }
                } catch (e) {
                  // Continue searching
                }
              }
              if (driftData) break;
            }

            if (!driftData) {
              console.log('No drift-sentinel.json found in artifacts. Skipping issue update.');
              return;
            }

            const { summary, warnings, probes, expectationsVersion, timestamp } = driftData;

            // Only create/update issue if drift was detected
            if (summary.driftCount === 0) {
              console.log('No drift detected. Skipping issue update.');
              return;
            }

            const issueTitle = `[Drift Sentinel] API schema drift detected (v${expectationsVersion})`;

            // Build issue body
            const probeDetails = probes
              .filter(p => p.driftDetected)
              .map(p => `- **${p.provider}/${p.endpoint}** (${p.mode} mode): ${p.details || 'drift detected'}`)
              .join('\n');

            const issueBody = `## Drift Sentinel Report

            **Timestamp:** ${timestamp}
            **Expectations Version:** ${expectationsVersion}

            ### Summary
            - Drift detected: ${summary.driftCount}
            - Errors: ${summary.errorCount}
            - Inconclusive: ${summary.inconclusiveCount}
            - Skipped: ${summary.skippedCount}

            ### Drift Details
            ${probeDetails || 'No specific details available'}

            ### Warnings
            ${warnings.map(w => `- ${w}`).join('\n') || 'None'}

            ---
            *This issue is automatically updated by the nightly E2E workflow.*
            *Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*
            `.split('\n').map(l => l.trim()).join('\n');

            // Search for existing drift issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'drift-sentinel',
              state: 'open'
            });

            const existingIssue = issues.find(i => i.title.includes('[Drift Sentinel]'));

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing drift issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['drift-sentinel', 'automated']
              });
              console.log('Created new drift tracking issue');
            }
